<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galaxy Christmas Challenge</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L2MHS96YCN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-L2MHS96YCN');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { margin: 0; background-color: #000; font-family: 'Noto Sans TC', sans-serif; overflow: hidden; touch-action: none; user-select: none; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-wrapper { position: relative; width: 100%; height: 100%; max-width: 500px; background: radial-gradient(circle at 50% 120%, #0a1a3a 0%, #000000 80%); overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        canvas { display: block; width: 100%; height: 100%; }
        #danger-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 20%; background: linear-gradient(to top, rgba(255, 0, 50, 0.3), transparent); pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 5; }
        .danger-pulse { animation: pulseRed 1s infinite alternate; }
        @keyframes pulseRed { from { opacity: 0.1; } to { opacity: 0.4; } }
        #flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 40; transition: opacity 0.1s; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px); z-index: 50; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 1; visibility: visible; padding: 20px; }
        .ui-layer.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .modal-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 60; display: flex; flex-direction: column; align-items: center; padding-top: 60px; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); transform: translateY(100%); }
        .modal-layer.active { transform: translateY(0); }
        #hud { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); padding: 8px 20px; display: flex; flex-direction: column; align-items: center; pointer-events: none; z-index: 10; background: rgba(0,0,0,0.5); border-radius: 20px; border: 1px solid rgba(0, 195, 255, 0.3); backdrop-filter: blur(4px); }
        
        /* New Combo HUD Styles */
        #combo-hud { position: absolute; top: 20px; left: 20px; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: flex-start; }
        .combo-label { font-size: 10px; color: #ffd700; letter-spacing: 2px; font-family: 'Orbitron'; opacity: 0.8; font-weight: bold; margin-bottom: -5px; }
        .combo-value { font-family: 'Orbitron', sans-serif; font-size: 36px; color: #ffd700; font-weight: 900; text-shadow: 0 0 15px rgba(255, 215, 0, 0.6); line-height: 1; transition: transform 0.1s; font-style: italic; }
        .combo-pulse .combo-value { animation: comboPop 0.15s ease-out; color: #fff; }
        @keyframes comboPop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        .hud-label { font-size: 10px; color: #00c3ff; letter-spacing: 2px; font-family: 'Orbitron'; opacity: 0.9; }
        .hud-value { font-family: 'Orbitron', sans-serif; font-size: 24px; color: white; font-weight: bold; text-shadow: 0 0 10px rgba(0, 195, 255, 0.5); line-height: 1; }
        .lb-container-mini { width: 100%; max-width: 340px; background: rgba(10, 20, 40, 0.6); border: 1px solid rgba(0, 195, 255, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 0 30px rgba(0, 195, 255, 0.05); backdrop-filter: blur(5px); }
        .lb-container-full { width: 95%; max-width: 420px; height: 65vh; overflow-y: auto; background: rgba(10, 15, 20, 0.8); border: 1px solid #333; border-radius: 4px; padding: 10px; margin-bottom: 20px; }
        .lb-title { color: #00c3ff; font-size: 14px; letter-spacing: 2px; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .lb-row { display: flex; justify-content: space-between; align-items: center; color: #aaa; font-size: 14px; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: 'Orbitron', sans-serif; transition: background 0.2s; }
        .lb-row.highlight { background: linear-gradient(90deg, rgba(0, 195, 255, 0.15), transparent); border-left: 3px solid #00c3ff; color: white; }
        .rank-1 { color: #ffd700 !important; font-weight: 900; text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); font-size: 1.1em; }
        .rank-2 { color: #e0e0e0 !important; font-weight: bold; }
        .rank-3 { color: #c58f60 !important; font-weight: bold; }
        .btn-primary { 
            background: #000; 
            border: 1px solid #00c3ff; 
            padding: 16px 40px; 
            color: #00c3ff; 
            font-family: 'Orbitron', sans-serif; 
            font-weight: bold; 
            font-size: 18px; 
            letter-spacing: 2px; 
            border-radius: 50px; 
            cursor: pointer; 
            box-shadow: 0 0 15px rgba(0, 195, 255, 0.2); 
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1); 
            text-transform: uppercase; 
            width: 100%; 
            position: relative; 
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1.2;
        }
        .btn-primary::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0, 195, 255, 0.2), transparent); transition: 0.5s; }
        .btn-primary:hover { background: #00c3ff; color: #000; box-shadow: 0 0 30px rgba(0, 195, 255, 0.6); }
        .btn-primary:hover::after { left: 100%; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-attract { animation: neonPulse 2s infinite ease-in-out; border-width: 2px; text-shadow: 0 0 10px rgba(0, 195, 255, 0.8); }
        @keyframes neonPulse { 0% { box-shadow: 0 0 5px rgba(0, 195, 255, 0.3); transform: scale(1); } 50% { box-shadow: 0 0 25px rgba(0, 195, 255, 0.8), 0 0 50px rgba(0, 195, 255, 0.4); transform: scale(1.05); border-color: #fff; color: #fff; } 100% { box-shadow: 0 0 5px rgba(0, 195, 255, 0.3); transform: scale(1); } }
        .btn-secondary { background: transparent; border: 1px solid #444; padding: 12px; color: #888; font-size: 14px; border-radius: 50px; cursor: pointer; margin-top: 12px; width: 100%; transition: all 0.2s; letter-spacing: 1px; }
        .btn-secondary:hover { border-color: white; color: white; }
        .btn-text { background: none; border: none; color: #666; font-size: 12px; text-decoration: none; cursor: pointer; margin-top: 15px; transition: color 0.2s; letter-spacing: 1px; }
        .btn-text:hover { color: #00c3ff; text-decoration: underline; }
        input.glass-input { background: rgba(0, 0, 0, 0.5); border: 1px solid #333; padding: 14px; width: 100%; color: white; border-radius: 8px; margin-bottom: 12px; outline: none; font-family: 'Noto Sans TC'; transition: border-color 0.3s; }
        input.glass-input:focus { border-color: #00c3ff; }
        .flagship-ticket { position: relative; background: transparent; border-radius: 16px; width: 100%; max-width: 360px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8); background-image: url('https://raw.githubusercontent.com/andyhhsu/Galaxy-Christmas-Challenge/main/newcard.jpg'); background-size: cover; background-position: center; min-height: 180px; display: flex; flex-direction: column; justify-content: flex-end; }
        .ticket-overlay { background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 50%, transparent 100%); padding: 15px 20px; display: flex; justify-content: space-between; align-items: flex-end; width: 100%; }
        .ticket-info-block { text-align: left; }
        .ticket-player-name { color: #fff; font-weight: bold; font-size: 16px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-family: 'Orbitron'; }
        .ticket-label-sm { color: #00c3ff; font-size: 10px; letter-spacing: 1px; font-weight: bold; text-transform: uppercase; }
        .ticket-score-block { text-align: right; }
        .ticket-score-big { color: #ffd700; font-family: 'Orbitron'; font-size: 20px; font-weight: 900; line-height: 1; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .redeem-text { color: #ffd700; font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 20px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); animation: pulseText 2s infinite; font-family: 'Noto Sans TC'; letter-spacing: 1px; }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .instruction-box { background: rgba(10, 12, 16, 0.9); border: 1px solid #333; border-left: 3px solid #00c3ff; border-radius: 8px; padding: 16px; width: 100%; max-width: 420px; margin-bottom: 20px; text-align: left; }
        .inst-title { color: #fff; font-weight: bold; font-size: 14px; margin-bottom: 8px; letter-spacing: 2px; font-family: 'Orbitron'; }
        .inst-list { font-size: 14px; color: #ccc; list-style: none; padding: 0; line-height: 1.6; }
        .inst-list li::before { content: ">> "; color: #00c3ff; }
        .inst-icons { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #222; padding-top: 10px; }
        .inst-icon-item { text-align: center; width: 18%; }
        .inst-icon-emoji { font-size: 24px; margin-bottom: 4px; display: block; filter: drop-shadow(0 0 5px rgba(0,195,255,0.5)); }
        .inst-icon-text { font-size: 10px; color: #888; line-height: 1.2; }
        .inst-icon-emoji.nuke { filter: drop-shadow(0 0 8px #ef4444); }
        .inst-icon-emoji.multi { filter: drop-shadow(0 0 8px #22c55e); }
        .prize-box { background: transparent; border: none; padding: 0; width: 100%; max-width: 420px; margin-bottom: 10px; }
        .prize-img { width: 100%; height: auto; border-radius: 8px; border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .xmas-deco { position: absolute; pointer-events: none; z-index: 45; }
        .xmas-sock { top: 10%; right: 10%; font-size: 40px; transform: rotate(15deg); filter: drop-shadow(0 0 10px red); animation: sway 3s infinite ease-in-out alternate; }
        .xmas-ball { top: 15%; left: 10%; font-size: 35px; filter: drop-shadow(0 0 10px gold); animation: bounce-slow 4s infinite ease-in-out; }
        .xmas-snow { bottom: 5%; right: 5%; font-size: 25px; opacity: 0.7; }
        @keyframes sway { from { transform: rotate(10deg); } to { transform: rotate(20deg); } }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .total-play-count { position: absolute; top: 20px; left: 20px; font-family: 'Orbitron', sans-serif; font-size: 10px; color: #aaa; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 15px; border: 1px solid #333; pointer-events: none; z-index: 40; display: flex; flex-direction: column; align-items: center; }
        .total-play-count span { color: #00c3ff; font-weight: bold; font-size: 14px; margin-top: 2px; }
        .music-toggle { position: absolute; top: 20px; right: 20px; z-index: 100; background: rgba(0,0,0,0.6); border: 1px solid #333; color: #00c3ff; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; }
        .music-toggle:hover { background: rgba(0, 195, 255, 0.2); border-color: #00c3ff; }
        .music-toggle.muted { color: #555; border-color: #555; }
    </style>
</head>
<body onclick="game.unlockAudio()"> 

<audio id="bgm" loop preload="auto">
    <source src="https://raw.githubusercontent.com/andyhhsu/Galaxy-Christmas-Challenge/main/8-bit-takeover-367276.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<div id="game-wrapper">
    
    <div class="music-toggle" id="musicBtn" onclick="game.audio.toggleMute(); event.stopPropagation();">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="danger-overlay"></div>
        <div id="flash-overlay"></div>

        <!-- Combo Display -->
        <div id="combo-hud" class="hidden">
            <div class="combo-label">COMBO</div>
            <div class="combo-value" id="comboVal">0</div>
        </div>

        <!-- HUD -->
        <div id="hud">
            <div class="hud-item">
                <div class="hud-label">SCORE</div>
                <div class="hud-value" id="scoreVal">0</div>
            </div>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤º -->
        <div id="mode-indicator" style="position:absolute; bottom:140px; left:50%; transform:translateX(-50%); opacity:0; pointer-events:none; color:#00c3ff; font-weight:bold; background:rgba(0,0,0,0.8); padding:5px 15px; border-radius:4px; font-size:12px; transition:opacity 0.3s; border:1px solid #00c3ff; font-family: 'Orbitron'; letter-spacing: 2px;">MODE</div>

        <!-- 1. Start Screen -->
        <div id="startScreen" class="ui-layer">
            
            <div class="xmas-deco xmas-sock">ğŸ§¦</div>
            <div class="xmas-deco xmas-ball">ğŸ„</div>
            <div class="xmas-deco xmas-snow">â„ï¸</div>

            <div class="total-play-count">
                ç´¯ç©æŒ‘æˆ°
                <span id="globalPlayCount">...</span>
            </div>

            <div class="text-center mb-8 mt-4">
                <h1 class="text-4xl md:text-6xl font-black text-white tracking-tighter mb-1" style="font-family: 'Orbitron'; text-shadow: 0 0 20px rgba(0,195,255,0.5);">GALAXY</h1>
                <h2 class="text-base md:text-xl text-red-600 tracking-[0.3em] font-bold font-orbitron mt-2 whitespace-nowrap" style="text-shadow: 0 0 10px rgba(220,38,38,0.8);">CHRISTMAS CHALLENGE</h2>
            </div>
            
            <!-- Top 3 Leaderboard -->
            <div class="lb-container-mini">
                <div class="lb-title">RANKINGS</div>
                <div id="top3-list" class="flex flex-col gap-2">
                    <div class="text-center text-gray-500 text-xs font-mono">LOADING_DATA...</div>
                </div>
                <button class="btn-text w-full text-center" onclick="api.openFullLeaderboard(); event.stopPropagation();">æŸ¥çœ‹å®Œæ•´æ’è¡Œæ¦œ >></button>
            </div>

            <div class="w-full max-w-xs flex flex-col items-center">
                <button class="btn-primary btn-attract" onclick="game.showInstructions()">START</button>
            </div>
        </div>

        <!-- 1.5 Instruction Screen -->
        <div id="instructionScreen" class="ui-layer hidden">
            <div class="w-full max-w-md flex justify-between items-end mb-4">
                 <h2 class="text-4xl font-bold text-white" style="font-family: 'Noto Sans TC'">éŠæˆ²èªªæ˜</h2>
                 <div class="text-[#00c3ff] text-xs tracking-widest">SYSTEM READY</div>
            </div>
            
            <div class="instruction-box">
                <div class="inst-title">HOW TO PLAY</div>
                <ul class="inst-list">
                    <li>æ»‘å‹•æ“‹æ¿ï¼Œæ¥ä½èƒ½é‡çƒã€‚</li>
                    <li>é€£çºŒæ“Šç¢ç£šå¡Šå¯ç´¯ç© <span class="text-[#ffd700] font-bold">COMBO</span> åŠ åˆ†ã€‚</li>
                    <li>æ¥ä½é“å…·è§¸ç™¼ Galaxy ç‰¹æ•ˆï¼š</li>
                </ul>
                <div class="inst-icons">
                    <div class="inst-icon-item">
                        <div class="inst-icon-emoji">ğŸ“±</div>
                        <div class="inst-icon-text">æ‘ºç–Šæ“´å±•</div>
                    </div>
                    <div class="inst-icon-item">
                        <div class="inst-icon-emoji">ğŸ–Šï¸</div>
                        <div class="inst-icon-text">S Pen</div>
                    </div>
                    <div class="inst-icon-item">
                        <div class="inst-icon-emoji">â„ï¸</div>
                        <div class="inst-icon-text">AI æ…¢å‹•ä½œ</div>
                    </div>
                    <div class="inst-icon-item">
                        <div class="inst-icon-emoji multi">ğŸ”´</div>
                        <div class="inst-icon-text">æ¥µé™å¤šå·¥</div>
                    </div>
                    <div class="inst-icon-item">
                        <div class="inst-icon-emoji nuke">ğŸ</div>
                        <div class="inst-icon-text">æ˜Ÿéš›è½Ÿç‚¸</div>
                    </div>
                </div>
            </div>

            <!-- Updated Prize Box with Image -->
            <div class="prize-box">
                <div class="text-[#ffd700] text-xs font-bold mb-2 text-center tracking-widest">æ’è¡ŒæŒ‘æˆ°ç¦® (2026/1/2å…¬å¸ƒè‡‰æ›¸ç²‰å°ˆ)</div>
                <img src="https://raw.githubusercontent.com/andyhhsu/Galaxy-Christmas-Challenge/main/reward4.png" alt="Rewards List" class="prize-img">
            </div>
            
            <div class="mb-4 text-[12px] text-[#00c3ff] text-center font-bold tracking-wide">
                æ†‘æˆç¸¾ç™»éŒ„æˆªåœ–ï¼Œå¯è‡³æŒ‡å®šä¸‰æ˜Ÿæ™ºæ…§é¤¨å…Œæ›ã€Œç¥ç§˜å°ç¦®ã€
            </div>

            <button class="btn-primary max-w-xs mt-2" onclick="game.startRealGame()">é–‹å§‹éŠæˆ²</button>
        </div>


        <!-- 2. Game Over / Form Screen -->
        <div id="formScreen" class="ui-layer hidden">
            <h2 class="text-4xl font-bold text-white mb-2" style="font-family: 'Noto Sans TC'">éŠæˆ²çµæŸ</h2>
            
            <div class="text-center mb-6">
                 <div class="text-gray-500 text-xs tracking-widest mb-1">æœ€çµ‚åˆ†æ•¸</div>
                 <div class="text-white font-bold text-4xl font-mono text-shadow-blue" id="finalScore">0</div>
                 <div id="rankPrediction" class="text-[#00c3ff] text-sm font-bold mt-2 animate-pulse">è¨ˆç®—æ’åä¸­...</div>
            </div>
            
            <div class="bg-[#0a0a0a] p-6 rounded-xl w-full max-w-sm border border-gray-800 shadow-2xl">
                <h3 class="text-white font-bold mb-6 text-center text-sm tracking-wide">ç™»éŒ„æˆç¸¾ & åƒåŠ æŠ½ç</h3>
                <input type="text" id="uName" class="glass-input" placeholder="å§“å / æš±ç¨±">
                <input type="tel" id="uPhone" class="glass-input" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                
                <div class="flex items-center justify-center gap-3 mb-6 bg-[#111] p-3 rounded border border-[#222]">
                    <span class="text-xl">âš¡</span>
                    <div>
                        <div class="text-sm text-white font-bold">ç™»éŒ„å³å¯æŠ½ 10,000mAh è¡Œå‹•é›»æº</div>
                        <div class="text-[10px] text-gray-500">(2026/1/2æŠ½å‡º)</div>
                    </div>
                </div>

                <button class="btn-primary mb-3" id="submitBtn" onclick="api.submitScore()">ç¢ºèªé€å‡º</button>
                <button class="btn-secondary mb-3" onclick="game.restartGame()">ä¸åƒåŠ ï¼Œç›´æ¥é‡ç©</button>
                <button class="btn-text text-gray-500 text-xs w-full" onclick="game.backToHome()">å›åˆ°ä¸»ç•«é¢</button>
            </div>
        </div>

        <!-- 3. Flagship Ticket Screen -->
        <div id="ticketScreen" class="ui-layer hidden">
            
            <div class="text-center mb-6">
                <div class="text-[#00c3ff] text-4xl mb-2">âœ“</div>
                <h2 class="text-xl font-bold text-white tracking-wide">ä¸Šå‚³æˆåŠŸ</h2>
            </div>

            <div class="flagship-ticket">
                <!-- Overlay content on top of the card image -->
                <div class="ticket-overlay">
                    <div class="ticket-info-block">
                        <div class="ticket-label-sm">CHALLENGER</div>
                        <div class="ticket-player-name" id="ticketName">PLAYER</div>
                    </div>
                    <div class="ticket-score-block">
                        <div class="ticket-label-sm">SCORE</div>
                        <div class="ticket-score-big" id="ticketScore">0</div>
                    </div>
                </div>
            </div>
            <!-- æ–°å¢å…Œæ›æé†’æ–‡å­— -->
            <div class="redeem-text">æ†‘æ­¤é é¢æˆªåœ–ï¼Œå¯è‡³æŒ‡å®šä¸‰æ˜Ÿæ™ºæ…§é¤¨å…Œæ›ã€Œç¥ç§˜å°ç¦®ã€</div>

            <div class="w-full max-w-xs flex flex-col gap-3">
                <button class="btn-secondary border-[#00c3ff] text-[#00c3ff]" onclick="api.openFullLeaderboard()">æŸ¥çœ‹æ’å</button>
                <button class="btn-primary" onclick="game.restartGame()">å†æ¬¡æŒ‘æˆ°</button>
                <button class="btn-text text-gray-500 text-xs mt-2" onclick="game.backToHome()">å›åˆ°ä¸»ç•«é¢</button>
            </div>
        </div>

        <!-- 4. Leaderboard Modal -->
        <div id="leaderboardModal" class="modal-layer">
            <h2 class="text-2xl font-bold text-white mb-2" style="font-family: 'Noto Sans TC'">å®Œæ•´æ’è¡Œæ¦œ</h2>
            <p class="text-[#00c3ff] text-xs mb-4 tracking-widest">å³æ™‚æˆ°æ³</p>
            
            <div class="lb-container-full" id="full-lb-list">
                <!-- JS Populated -->
            </div>
            
            <button class="btn-secondary max-w-xs mt-4" onclick="api.closeFullLeaderboard()">é—œé–‰</button>
        </div>
    </div>
</div>

<script>
// --- Google Sheets API Manager ---
const GoogleSheetAPI = {
    scriptID: "AKfycbxdYUWV5J9symUn7xpbNdFbwm8zjJKz0YKA8nkYmewTpc_HT0kUcLLLrGmYCMNIWHpt",
    
    get scriptURL() { return `https://script.google.com/macros/s/${this.scriptID}/exec`; },

    leaderboardData: [],
    globalPlayCount: 0, // Set initial to 0 to reflect backend if empty

    mockData: [ { name: "AI_AGENT", score: 15000 }, { name: "Z_FOLD_PRO", score: 12500 }, { name: "VIP_MEMBER", score: 9800 }, { name: "GUEST_001", score: 5000 } ],

    init: function() {
        this.fetchLeaderboard();
        this.updatePlayCount();
    },

    updatePlayCount: function() {
        // FIX 1: åŠ ä¸Šæ™‚é–“æˆ³è¨˜ t=Date.now() å¼·åˆ¶é¿é–‹å¿«å–ï¼Œè§£æ±ºæ­¸é›¶å¾Œé¡¯ç¤ºèˆŠè³‡æ–™å•é¡Œ
        const el = document.getElementById('globalPlayCount');
        if(el) el.innerText = "...";

        fetch(this.scriptURL + "?action=get_play_count&t=" + Date.now())
            .then(res => res.json())
            .then(data => {
                if (typeof data.count === 'number') {
                    this.globalPlayCount = data.count;
                    if(el) el.innerText = this.globalPlayCount.toLocaleString();
                    localStorage.setItem('playCount', this.globalPlayCount);
                }
            })
            .catch(e => {
                console.error(e);
                // Fallback only if API completely fails
                const stored = localStorage.getItem('playCount');
                if (stored && el) el.innerText = parseInt(stored).toLocaleString();
            });
    },

    incrementPlayCount: function() {
        this.globalPlayCount++;
        localStorage.setItem('playCount', this.globalPlayCount);
        document.getElementById('globalPlayCount').innerText = this.globalPlayCount.toLocaleString();
        fetch(this.scriptURL + "?action=increment_play_count").catch(console.error);
    },

    fetchLeaderboard: async function() {
        try {
            const response = await fetch(this.scriptURL + "?action=get&t=" + Date.now());
            const data = await response.json();
            data.sort((a, b) => b.score - a.score);
            this.leaderboardData = data;
            this.renderTop3(data);
        } catch (e) {
            console.warn("API Fetch Failed", e);
            this.leaderboardData = this.mockData;
            this.renderTop3(this.mockData);
        }
    },

    predictRank: function(score) {
        let rank = 1;
        for(let item of this.leaderboardData) {
            if(item.score >= score) rank++;
        }
        return rank;
    },

    renderTop3: function(data) {
        const listEl = document.getElementById('top3-list');
        listEl.innerHTML = "";
        const top3 = data.slice(0, 3);
        top3.forEach((item, index) => {
            const row = document.createElement('div');
            row.className = `lb-row`;
            let rankClass = index === 0 ? "rank-1" : (index === 1 ? "rank-2" : "rank-3");
            let rankText = index === 0 ? "1ST" : (index === 1 ? "2ND" : "3RD");
            row.innerHTML = `<div class="flex items-center gap-3 w-full"><span class="text-sm w-8 text-center ${rankClass}" style="font-family:'Orbitron'">${rankText}</span><span class="flex-1 text-left truncate font-bold text-white">${item.name}</span><span class="font-mono text-[#00c3ff]">${item.score}</span></div>`;
            listEl.appendChild(row);
        });
    },

    renderFullList: function(highlightName = null, highlightScore = null) {
        const listEl = document.getElementById('full-lb-list');
        listEl.innerHTML = "";
        this.leaderboardData.forEach((item, index) => {
            const rank = index + 1;
            const row = document.createElement('div');
            row.className = `lb-row`;
            if (highlightName && item.name === highlightName && item.score == highlightScore) { row.classList.add('highlight'); }
            let rankColor = rank === 1 ? "rank-1" : (rank === 2 ? "rank-2" : (rank === 3 ? "rank-3" : ""));
            row.innerHTML = `<span class="w-10 font-bold ${rankColor}" style="font-family:'Orbitron'">#${rank}</span><span class="flex-1 text-left truncate px-2 text-gray-300">${item.name}</span><span class="w-20 text-right font-mono text-[#00c3ff]">${item.score}</span>`;
            listEl.appendChild(row);
        });
    },

    openFullLeaderboard: function() { document.getElementById('leaderboardModal').classList.add('active'); this.renderFullList(); gtag('event', 'view_leaderboard'); },
    closeFullLeaderboard: function() { document.getElementById('leaderboardModal').classList.remove('active'); },

    submitScore: function() {
        const name = document.getElementById('uName').value.trim();
        const phone = document.getElementById('uPhone').value.trim();
        const score = parseInt(document.getElementById('finalScore').innerText);

        if(!name || !phone) { alert('è«‹è¼¸å…¥å§“åèˆ‡é›»è©±ä»¥ä¾¿å…Œæ›çå“'); return; }
        const btn = document.getElementById('submitBtn'); btn.innerText = "UPLOADING..."; btn.disabled = true;
        document.getElementById('ticketName').innerText = name; document.getElementById('ticketScore').innerText = score;

        const formData = new FormData();
        formData.append('name', name); formData.append('phone', phone); formData.append('score', score); formData.append('action', 'add');
        gtag('event', 'generate_lead', { 'event_category': 'game', 'event_label': 'score_submit', 'value': score });
        fetch(this.scriptURL, { method: 'POST', body: formData }).then(res => res.json()).then(() => { this.fetchLeaderboard(); }).catch(console.error);
        setTimeout(() => {
            document.getElementById('formScreen').classList.add('hidden');
            document.getElementById('ticketScreen').classList.remove('hidden');
            this.leaderboardData.push({name: name, score: score}); this.leaderboardData.sort((a, b) => b.score - a.score);
        }, 800); 
    }
};

// --- Game Engine ---
class SoundManager {
    constructor() { 
        this.ctx = new (window.AudioContext || window.webkitAudioContext)(); 
        this.masterGain = this.ctx.createGain(); 
        this.masterGain.gain.value = 0.3; 
        this.masterGain.connect(this.ctx.destination); 
        this.enabled = false; 
        
        this.bgmEl = document.getElementById('bgm');
        this.bgmPlaying = false;
        this.muted = false; 
        this.shouldPlay = false; 

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.bgmEl.pause();
            } else {
                if (this.shouldPlay && !this.muted) {
                    this.bgmEl.play().catch(e => console.log("Resume failed", e));
                }
            }
        });
    }
    
    enable() { 
        if (this.ctx.state === 'suspended') {
            this.ctx.resume().then(() => {
                this.enabled = true;
            });
        } else {
            this.enabled = true;
        }
    }

    toggleMute() {
        this.muted = !this.muted;
        const btn = document.getElementById('musicBtn');
        
        if (this.muted) {
            this.bgmEl.pause();
            this.bgmPlaying = false;
            btn.classList.add('muted');
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`;
        } else {
            btn.classList.remove('muted');
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            
            if (this.shouldPlay) {
                this.bgmEl.volume = 0.4;
                const playPromise = this.bgmEl.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        this.bgmPlaying = true;
                    }).catch(error => {
                       console.log("Playback prevented. Interaction needed.");
                    });
                }
            }
        }
    }

    tryPlayBGM() {
        this.shouldPlay = true; 
        if (!this.muted) {
            this.bgmEl.volume = 0.4;
            this.bgmEl.currentTime = 0;
            const playPromise = this.bgmEl.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                   console.log("Autoplay prevented. Waiting for interaction.");
                });
            }
        }
    }

    stopBGM() {
        this.shouldPlay = false; 
        this.bgmEl.pause();
        this.bgmEl.currentTime = 0; 
        this.bgmPlaying = false;
    }

    playTone(freq, type, duration, slideTo) { 
        if(!this.enabled || this.muted) return; 
        try {
            const osc = this.ctx.createOscillator(); 
            const gain = this.ctx.createGain(); 
            osc.type = type; 
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime); 
            if(slideTo) osc.frequency.exponentialRampToValueAtTime(slideTo, this.ctx.currentTime + duration); 
            gain.gain.setValueAtTime(0.5, this.ctx.currentTime); 
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration); 
            osc.connect(gain); 
            gain.connect(this.masterGain); 
            osc.start(); 
            osc.stop(this.ctx.currentTime + duration); 
        } catch(e) {}
    }
    
    playHit() { this.playTone(300, 'sine', 0.1); }
    playPaddle() { this.playTone(150, 'triangle', 0.1); }
    playShoot() { this.playTone(800, 'square', 0.1, 200); }
    playPowerUp() { this.playTone(400, 'sine', 0.3, 800); setTimeout(() => this.playTone(600, 'sine', 0.3, 1200), 100); }
    playBreak() { this.playTone(100, 'sawtooth', 0.1); }
    playNuke() { this.playTone(100, 'sawtooth', 1.0, 50); }
    playGameOver() { this.playTone(300, 'sawtooth', 1.5, 50); }
}

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.audio = new SoundManager();
        
        this.width = this.canvas.clientWidth || window.innerWidth; 
        this.height = this.canvas.clientHeight || window.innerHeight; 
        this.canvas.width = this.width; 
        this.canvas.height = this.height; 

        this.resize();
        this.hudScore = document.getElementById('scoreVal');
        this.modeIndicator = document.getElementById('mode-indicator');
        this.dangerOverlay = document.getElementById('danger-overlay');
        this.flashOverlay = document.getElementById('flash-overlay');
        this.particles = []; this.initParticles();
        this.baseBallSpeed = 5.0;
        
        this.bgImage = new Image();
        this.bgImage.src = 'https://raw.githubusercontent.com/andyhhsu/Galaxy-Christmas-Challenge/main/background.png';
        
        this.cookieImage = new Image();
        this.cookieImage.src = 'https://raw.githubusercontent.com/andyhhsu/Galaxy-Christmas-Challenge/main/cookie.png';

        this.reset(); this.bindEvents();
        window.addEventListener('resize', () => { this.resize(); this.initParticles(); if(!this.running) this.drawStaticBackground(); });
        
        this.bgImage.onload = () => { if(!this.running) this.drawStaticBackground(); };
        
        this.drawStaticBackground();
        GoogleSheetAPI.init();
        this.idleTime = null; this.resetIdleTimer = this.resetIdleTimer.bind(this);
        ['mousemove', 'mousedown', 'keypress', 'touchmove', 'touchstart', 'click'].forEach(evt => window.addEventListener(evt, this.resetIdleTimer));
        this.resetIdleTimer();
    }
    
    unlockAudio() {
        this.audio.enable();
    }

    drawRoundedRect(x, y, w, h, r) {
        if (w < 2 * r) r = w / 2;
        if (h < 2 * r) r = h / 2;
        this.ctx.beginPath();
        this.ctx.moveTo(x + r, y);
        this.ctx.arcTo(x + w, y, x + w, y + h, r);
        this.ctx.arcTo(x + w, y + h, x, y + h, r);
        this.ctx.arcTo(x, y + h, x, y, r);
        this.ctx.arcTo(x, y, x + w, y, r);
        this.ctx.closePath();
        this.ctx.fill();
    }

    drawPaddle(x, y, w, h, state, color) {
        if (this.gingerbreadMode && this.cookieImage.complete && this.cookieImage.naturalWidth > 0) {
             const pSize = 40; 
             const count = Math.ceil(w / pSize); 
             for(let i=0; i<count; i++) {
                 this.ctx.drawImage(this.cookieImage, x + i * pSize, y - 10, pSize, pSize);
             }
             return;
        }

        const grad = this.ctx.createLinearGradient(x, y, x, y + h);
        grad.addColorStop(0, '#333'); grad.addColorStop(0.2, '#666'); grad.addColorStop(0.5, '#222'); grad.addColorStop(1, '#111');
        this.ctx.fillStyle = grad;
        this.ctx.shadowBlur = 15; this.ctx.shadowColor = color; 
        
        this.drawRoundedRect(x, y, w, h, 4);
        this.ctx.shadowBlur = 0;

        const margin = 2;
        const sw = w - (margin*2);
        const sh = h - (margin*2);
        this.ctx.fillStyle = color; 
        
        if (state === 'cover') {
            this.ctx.fillRect(x+margin, y+margin, sw, sh);
            this.ctx.fillStyle = '#000'; this.ctx.beginPath(); this.ctx.arc(x + w/2, y + 4, 1.5, 0, Math.PI*2); this.ctx.fill();
        } else if (state === 'main') {
            const half = sw / 2;
            this.ctx.fillRect(x+margin, y+margin, half-1, sh);
            this.ctx.fillRect(x+margin+half+1, y+margin, half-1, sh);
            this.ctx.fillStyle = '#444'; this.ctx.fillRect(x+w/2-1, y, 2, h);
        } else if (state === 'trifold') {
            const third = sw / 3;
            this.ctx.fillRect(x+margin, y+margin, third-1, sh);
            this.ctx.fillRect(x+margin+third+1, y+margin, third-1, sh);
            this.ctx.fillRect(x+margin+(third*2)+2, y+margin, third-1, sh);
            this.ctx.fillStyle = '#444';
            this.ctx.fillRect(x+w/3-1, y, 2, h);
            this.ctx.fillRect(x+(w*2)/3-1, y, 2, h);
        }
    }

    resize() { 
        const wrapper = document.getElementById('game-wrapper'); 
        let w = wrapper.clientWidth;
        let h = wrapper.clientHeight;
        
        if (w < 10 || h < 10) {
            w = window.innerWidth;
            h = window.innerHeight;
        }

        this.width = w; 
        this.height = h; 
        this.canvas.width = this.width; 
        this.canvas.height = this.height; 

        if (this.paddle) {
            this.paddle.y = this.height - 120;
            if (this.paddle.x > this.width - this.paddle.w) {
                this.paddle.x = this.width - this.paddle.w;
            }
        }
    }
    resetIdleTimer() { 
        clearTimeout(this.idleTime); 
        this.idleTime = setTimeout(() => { 
            if (document.getElementById('startScreen').classList.contains('hidden') && !this.running) {
                this.backToHome(); 
            }
        }, 30000); 
    }
    initParticles() { this.bgParticles = []; for(let i=0; i<40; i++) this.bgParticles.push({ x: Math.random() * this.width, y: Math.random() * this.height, size: Math.random() * 2 + 1, speed: Math.random() * 0.5 + 0.2, alpha: Math.random() * 0.5 }); }
    bindEvents() {
        const moveHandler = (x) => { if(!this.running) return; const wrapper = document.getElementById('game-wrapper'); const rect = wrapper.getBoundingClientRect(); const relativeX = x - rect.left; this.paddle.x = relativeX - this.paddle.w / 2; if(this.paddle.x < 0) this.paddle.x = 0; if(this.paddle.x + this.paddle.w > this.width) this.paddle.x = this.width - this.paddle.w; };
        this.canvas.addEventListener('mousemove', e => moveHandler(e.clientX));
        this.canvas.addEventListener('touchstart', e => { e.preventDefault(); moveHandler(e.touches[0].clientX); }, { passive: false });
        this.canvas.addEventListener('touchmove', e => { e.preventDefault(); moveHandler(e.touches[0].clientX); }, { passive: false });
    }
    
    reset() {
        this.running = false; this.score = 0; if(this.hudScore) this.hudScore.innerText = "0";
        this.combo = 0; 
        const comboVal = document.getElementById('comboVal');
        if(comboVal) comboVal.innerText = "0";
        
        this.difficultyLevel = 1; this.lastBrickSpawnTime = 0; this.lastShotTime = 0;
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        this.brickSpeed = isTouch ? 1.2 : 1.0; this.baseBallSpeed = isTouch ? 2.5 : 5.0;
        
        const paddleY = this.height - 120;
        this.paddle = { w: 100, h: 24, x: this.width/2 - 50, y: paddleY, color: '#00c3ff', state: 'cover' };
        
        this.balls = []; this.balls.push({ x: this.width/2, y: paddleY - 20, r: 8, dx: 0, dy: 0, speed: this.baseBallSpeed, active: false, prevY: paddleY - 20 });
        this.bricks = []; this.particles = []; this.powerUps = []; this.bullets = [];
        this.aiMode = false; this.spenMode = false; this.gingerbreadMode = false; this.dangerOverlay.classList.remove('danger-pulse');
    }
    showInstructions() { 
        document.getElementById('startScreen').classList.add('hidden'); 
        document.getElementById('instructionScreen').classList.remove('hidden'); 
        GoogleSheetAPI.incrementPlayCount(); 
        this.audio.enable();
    } 
    startRealGame() { this.restartGame(); }
    start() { this.showInstructions(); }
    
    restartGame() {
        this.resize();
        this.audio.enable(); 
        this.audio.playPowerUp();
        this.audio.tryPlayBGM(); 

        document.getElementById('instructionScreen').classList.add('hidden');
        document.getElementById('formScreen').classList.add('hidden'); 
        document.getElementById('ticketScreen').classList.add('hidden');
        document.getElementById('leaderboardModal').classList.remove('active');
        
        // Show Combo HUD
        document.getElementById('combo-hud').classList.remove('hidden');
        
        gtag('event', 'game_restart');
        GoogleSheetAPI.incrementPlayCount();
        this.reset(); this.running = true; if(this.balls.length > 0) { this.balls[0].active = true; this.balls[0].dy = -this.balls[0].speed; this.balls[0].dx = (Math.random() - 0.5) * 6; } 
        
        this.spawnBrickRowSafe();
        this.loop();
    }

    backToHome() {
        this.running = false;
        this.audio.stopBGM();

        document.getElementById('instructionScreen').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
        document.getElementById('formScreen').classList.add('hidden');
        document.getElementById('ticketScreen').classList.add('hidden');
        document.getElementById('leaderboardModal').classList.remove('active');
        document.getElementById('combo-hud').classList.add('hidden');

        GoogleSheetAPI.fetchLeaderboard(); this.reset(); this.drawStaticBackground();
    }

    spawnBrickRowSafe() {
        if (this.width <= 0 || isNaN(this.width)) {
            console.warn("Width invalid, retrying spawn...");
            setTimeout(() => {
                this.resize(); 
                this.spawnBrickRowSafe();
            }, 100);
            return;
        }
        this.spawnBrickRow(4);
    }

    spawnBrickRow(count = 1, startY = null) {
        const cols = Math.floor(this.width / 60); 
        if(cols <= 0) return; 
        
        const offset = (this.width - (cols * 55)) / 2;
        for(let r=0; r<count; r++) {
            for(let c=0; c<cols; c++) {
                if(Math.random() > 0.85) continue; 
                const types = ['#00c3ff', '#0062cc', '#7c3aed', '#ffffff']; const color = types[Math.floor(Math.random() * types.length)];
                const yPos = startY !== null ? startY + r * 30 : -40 + r * 30;
                this.bricks.push({ x: offset + c * 55, y: yPos, w: 50, h: 20, status: 1, color: color });
            }
        }
    }
    gameOver(reason) {
        if(!this.running) return; this.running = false; this.audio.playGameOver(); 
        this.audio.stopBGM(); 
        document.getElementById('finalScore').innerText = this.score; gtag('event', 'level_end', { 'score': this.score, 'reason': reason });
        const predRank = GoogleSheetAPI.predictRank(this.score);
        document.getElementById('rankPrediction').innerText = `é æ¸¬æ’å: ç¬¬ ${predRank} å`;
        document.getElementById('formScreen').classList.remove('hidden');
        document.getElementById('combo-hud').classList.add('hidden'); // Hide combo on game over
        const btn = document.getElementById('submitBtn'); btn.innerText = "ç¢ºèªé€å‡º"; btn.disabled = false;
    }
    update() {
        this.bgParticles.forEach(p => { p.y += p.speed; if(p.y > this.height) { p.y = -5; p.x = Math.random() * this.width; } });
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        
        // é›£åº¦èª¿æ•´ï¼šçƒé€Ÿæ¯100,000åˆ†æå‡
        const speedStep = Math.floor(this.score / 100000); 
        const speedMult = isTouch ? 0.5 : 1.0; 
        const currentBallSpeed = this.baseBallSpeed + (speedStep * speedMult); 
        this.balls.forEach(ball => ball.speed = currentBallSpeed);
        
        this.brickSpeed = (isTouch ? 1.2 : 1.0) + Math.min(1.4, this.score / 20000); 
        if(Date.now() - this.lastBrickSpawnTime > 4000 - (this.difficultyLevel * 150)) { this.spawnBrickRow(4); this.lastBrickSpawnTime = Date.now(); if(this.difficultyLevel < 20) this.difficultyLevel++; }
        if(this.spenMode) { const now = Date.now(); if(now - this.lastShotTime > 200) { this.shootBullet(); this.lastShotTime = now; } }
        
        if (this.gingerbreadMode) {
            this.paddle.x = 0;
            this.paddle.w = this.width;
        }

        let danger = false; 
        this.bricks.forEach(b => { 
            if(b.status === 1) { 
                b.y += this.brickSpeed * (this.aiMode ? 0.5 : 1); 
                if(b.y + b.h > this.paddle.y - 150) danger = true; 
                
                if (this.gingerbreadMode && b.y + b.h >= this.paddle.y) {
                    this.destroyBrick(b);
                    return; 
                }

                if(b.y > this.height) b.status = 0; 
            } 
        });
        if(danger) this.dangerOverlay.classList.add('danger-pulse'); else this.dangerOverlay.classList.remove('danger-pulse');
        
        // Check for ball loss (Combo Reset)
        const initialBallCount = this.balls.length;
        this.balls = this.balls.filter(b => b.y <= this.height);
        if (this.balls.length < initialBallCount) {
            // Ball lost -> Reset Combo
            this.combo = 0;
            const comboEl = document.getElementById('comboVal');
            if(comboEl) {
                 comboEl.innerText = 0;
                 comboEl.parentElement.classList.remove('combo-pulse');
            }
        }

        if (this.balls.length === 0 && this.running) { 
             this.gameOver("SIGNAL LOST"); 
        }

        this.balls.forEach((ball, index) => {
            if (!ball.active) return; 
            
            if (Math.abs(ball.dx) < 1.5) {
                 ball.dx = (ball.dx >= 0 ? 1 : -1) * 2.0;
            }

            ball.prevY = ball.y; 
            ball.x += ball.dx * (this.aiMode ? 0.6 : 1); 
            ball.y += ball.dy * (this.aiMode ? 0.6 : 1);
            const maxSpeed = 14; if(ball.dy > maxSpeed) ball.dy = maxSpeed; if(ball.dy < -maxSpeed) ball.dy = -maxSpeed;
            
            if(ball.x + ball.r > this.width) { 
                ball.x = this.width - ball.r; 
                ball.dx *= -1; 
                this.audio.playHit(); 
            } else if(ball.x - ball.r < 0) { 
                ball.x = ball.r; 
                ball.dx *= -1; 
                this.audio.playHit(); 
            }

            if(ball.y - ball.r < 0) { ball.y = ball.r; ball.dy = Math.abs(ball.dy); this.audio.playHit(); }
            
            // Optimized Collision Logic
            let hit = false;
            
            // 1. Top Collision (Standard Bounce)
            // Check if ball center is within horizontal range of paddle
            if(ball.dy > 0 && ball.x >= this.paddle.x && ball.x <= this.paddle.x + this.paddle.w) {
                 // Check vertical overlap
                 if (ball.y + ball.r >= this.paddle.y && ball.y - ball.r < this.paddle.y + this.paddle.h) {
                     hit = true;
                 }
            }
            
            // 2. Corner/Edge Collision (if strict top check failed)
            if (!hit && ball.dy > 0) {
                 // Check if the ball's bounding box intersects with paddle's bounding box
                 // This catches cases where ball center is outside paddle but ball edge hits paddle
                 if (ball.x + ball.r >= this.paddle.x &&
                     ball.x - ball.r <= this.paddle.x + this.paddle.w &&
                     ball.y + ball.r >= this.paddle.y &&
                     ball.y - ball.r <= this.paddle.y + this.paddle.h) {
                     hit = true;
                 }
            }

            if(hit) { 
                ball.y = this.paddle.y - ball.r - 1; 
                ball.dy = -Math.abs(ball.speed); 
                
                let hitPoint = ball.x - (this.paddle.x + this.paddle.w/2); 
                hitPoint = hitPoint / (this.paddle.w / 2);
                ball.dx = hitPoint * 8 + (Math.random() - 0.5); 
                if (Math.abs(ball.dx) < 2) ball.dx = (ball.dx >= 0 ? 1 : -1) * 3; 
                
                this.audio.playPaddle(); 
                this.createParticles(ball.x, ball.y, '#fff'); 
            }
            this.bricks.forEach(b => { if(b.status === 1 && ball.x > b.x && ball.x < b.x+b.w && ball.y > b.y && ball.y < b.y+b.h) { ball.dy *= -1; this.destroyBrick(b); } });
        });

        this.powerUps.forEach((p, i) => { p.y += 3; if(p.y + 15 > this.paddle.y && p.y - 15 < this.paddle.y + this.paddle.h && p.x > this.paddle.x && p.x < this.paddle.x + this.paddle.w) { this.activatePowerUp(p.type); this.powerUps.splice(i, 1); } if(p.y > this.height) this.powerUps.splice(i, 1); });
        this.bullets.forEach((b, i) => { b.y -= 15; this.bricks.forEach(brick => { if(brick.status === 1 && b.x > brick.x && b.x < brick.x + brick.w && b.y > brick.y && b.y < brick.y + brick.h) { this.destroyBrick(brick); this.bullets.splice(i, 1); } }); if(b.y < 0) this.bullets.splice(i, 1); });
        this.particles.forEach((p, i) => { p.x += p.dx; p.y += p.dy; p.life -= 0.05; if(p.life <= 0) this.particles.splice(i, 1); });
        this.bricks = this.bricks.filter(b => b.status === 1);
    }
    destroyBrick(b) {
        b.status = 0; 
        
        // Combo Calculation
        this.combo++;
        const bonusMultiplier = 1 + (this.combo * 0.1); // 1.1, 1.2 ...
        const points = Math.floor(100 * bonusMultiplier);
        this.score += points;
        
        // Update HUD
        this.hudScore.innerText = this.score; 
        const comboEl = document.getElementById('comboVal');
        if(comboEl) {
            comboEl.innerText = this.combo;
            // Trigger pulse animation
            comboEl.parentElement.classList.remove('combo-pulse');
            void comboEl.parentElement.offsetWidth; // trigger reflow
            comboEl.parentElement.classList.add('combo-pulse');
        }

        this.audio.playBreak(); 
        this.createParticles(b.x + b.w/2, b.y + b.h/2, b.color);
        
        // Drop Logic
        const rand = Math.random();
        let type = null;
        
        // Difficulty: Drop rate reduction for 'Others'
        // Every 100,000 score -> Reduce 1% (0.01) chance
        const diffStep = Math.floor(this.score / 100000);
        const reduction = diffStep * 0.01;
        
        // Base chance for others is ~15% (from 0.01 to 0.16)
        // New max threshold = 0.16 - reduction
        let otherThreshold = 0.16 - reduction;
        if (otherThreshold < 0.01) otherThreshold = 0.01; // Cannot go below nuke threshold

        const isHighScore = this.score >= 1000000;

        // 0.000 - 0.005: Gingerbread (Only if score < 1M)
        if (rand < 0.005) {
            if (!isHighScore) type = 'gingerbread';
        } 
        // 0.005 - 0.010: Nuke (Only if score < 1M)
        else if (rand < 0.01) {
             if (!isHighScore) type = 'nuke';
        }
        // 0.010 - Threshold: Others (Decreasing probability)
        else if (rand < otherThreshold) {
             const r = Math.random();
             if (r < 0.25) type = 'multiball';
             else {
                 const commonTypes = ['expand', 'spen', 'ai'];
                 type = commonTypes[Math.floor(Math.random() * commonTypes.length)];
             }
        }
        
        if (type) this.powerUps.push({ x: b.x + b.w/2, y: b.y, type: type });
    }
    activatePowerUp(type) {
        this.audio.playPowerUp(); this.createFloatText(type.toUpperCase(), this.paddle.x, this.paddle.y - 50); gtag('event', 'power_up', { 'type': type });
        var self = this;
        
        if (type === 'gingerbread') {
             this.gingerbreadMode = true;
             setTimeout(() => {
                 this.gingerbreadMode = false;
                 this.paddle.w = 100; 
                 this.paddle.state = 'cover';
             }, 3000);
        }
        else if (type === 'nuke') { 
            this.audio.playNuke(); this.flashOverlay.style.opacity = '1'; setTimeout(function() { self.flashOverlay.style.opacity = '0'; }, 500); 
            this.bricks.forEach(function(b) { if(b.status === 1) { b.status = 0; self.score += 50; self.createParticles(b.x + b.w/2, b.y + b.h/2, '#fff'); } }); 
            this.hudScore.innerText = this.score; 
        }
        else if (type === 'multiball') { for(let i=0; i<2; i++) { this.balls.push({ x: this.paddle.x + this.paddle.w/2, y: this.paddle.y - 20, r: 8, dx: (Math.random() - 0.5) * 8, dy: -Math.abs(this.balls[0] ? this.balls[0].speed : this.baseBallSpeed), speed: this.balls[0] ? this.balls[0].speed : this.baseBallSpeed, active: true }); } }
        else if(type === 'expand') {
            const oldW = this.paddle.w; let newW = this.paddle.state === 'cover' ? 130 : 170; 
            this.paddle.state = this.paddle.state === 'cover' ? 'main' : 'trifold'; this.paddle.color = this.paddle.state === 'main' ? '#00c3ff' : '#7c3aed';
            this.paddle.x -= (newW - oldW) / 2; this.paddle.w = newW;
            if(this.paddle.x < 0) this.paddle.x = 0; if(this.paddle.x + this.paddle.w > this.width) this.paddle.x = this.width - this.paddle.w;
            setTimeout(() => { const currentW = this.paddle.w; this.paddle.x += (currentW - 100) / 2; this.paddle.w = 100; this.paddle.state = 'cover'; this.paddle.color = '#00c3ff'; }, 10000);
        } else if(type === 'spen') { this.spenMode = true; this.modeIndicator.innerText = "S PEN: RAPID FIRE"; this.modeIndicator.className = 'active-spen'; this.modeIndicator.style.opacity = '1'; setTimeout(() => { this.spenMode = false; this.modeIndicator.style.opacity = '0'; }, 5000); } 
        else if(type === 'ai') { this.aiMode = true; this.modeIndicator.innerText = "AI ASSIST: SLOW MOTION"; this.modeIndicator.className = 'active-ai'; this.modeIndicator.style.opacity = '1'; setTimeout(() => { this.aiMode = false; this.modeIndicator.style.opacity = '0'; }, 8000); }
        
        setTimeout(() => this.modeIndicator.style.opacity = '0', 1500); 
    }
    shootBullet() { this.audio.playShoot(); this.bullets.push({ x: this.paddle.x + 10, y: this.paddle.y, w: 4, h: 15 }); this.bullets.push({ x: this.paddle.x + this.paddle.w - 14, y: this.paddle.y, w: 4, h: 15 }); }
    createParticles(x, y, color) { for(let i=0; i<8; i++) this.particles.push({ x: x, y: y, dx: (Math.random()-0.5)*5, dy: (Math.random()-0.5)*5, life: 1, color: color }); }
    createFloatText(text, x, y) { const div = document.createElement('div'); div.innerText = text; div.style.position = 'absolute'; div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.color = '#fff'; div.style.fontWeight = 'bold'; div.style.fontSize = '20px'; div.style.textShadow = '0 0 10px #00c3ff'; div.style.pointerEvents = 'none'; div.style.transition = 'all 1s'; document.body.appendChild(div); requestAnimationFrame(() => { div.style.top = (y - 100) + 'px'; div.style.opacity = 0; }); setTimeout(() => div.remove(), 1000); }
    
    drawStaticBackground() { 
        if(this.bgImage.complete && this.bgImage.naturalWidth > 0) {
             this.ctx.drawImage(this.bgImage, 0, 0, this.width, this.height);
        } else {
             this.ctx.fillStyle = '#000'; 
             this.ctx.fillRect(0, 0, this.width, this.height);
        }
        
        this.ctx.fillStyle = 'rgba(0, 195, 255, 0.5)'; 
        if(this.bgParticles) { 
            this.bgParticles.forEach(p => { 
                this.ctx.globalAlpha = p.alpha; 
                this.ctx.fillRect(p.x, p.y, p.size, p.size); 
                this.ctx.globalAlpha = 1; 
            }); 
        } 
    }

    draw() {
        if(this.bgImage.complete && this.bgImage.naturalWidth > 0) {
            this.ctx.drawImage(this.bgImage, 0, 0, this.width, this.height);
        } else {
            this.ctx.fillStyle = '#000'; 
            this.ctx.fillRect(0, 0, this.width, this.height);
        }

        this.ctx.fillStyle = 'rgba(0, 195, 255, 0.5)'; this.bgParticles.forEach(p => { this.ctx.globalAlpha = p.alpha; this.ctx.fillRect(p.x, p.y, p.size, p.size); this.ctx.globalAlpha = 1; });
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; this.ctx.fillRect(0, 0, this.width, this.height);
        this.ctx.strokeStyle = 'rgba(0, 195, 255, 0.3)'; this.ctx.beginPath(); this.ctx.setLineDash([5, 15]); this.ctx.moveTo(0, this.paddle.y - 10); this.ctx.lineTo(this.width, this.paddle.y - 10); this.ctx.stroke(); this.ctx.setLineDash([]);
        
        this.drawPaddle(this.paddle.x, this.paddle.y, this.paddle.w, this.paddle.h, this.paddle.state, this.paddle.color);

        this.balls.forEach(ball => { if(ball.active) { this.ctx.beginPath(); this.ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); this.ctx.fillStyle = '#fff'; this.ctx.fill(); this.ctx.shadowBlur = 10; this.ctx.shadowColor = '#fff'; this.ctx.fill(); this.ctx.shadowBlur = 0; } });
        this.bricks.forEach(b => { this.ctx.fillStyle = b.color; this.ctx.fillRect(b.x, b.y, b.w, b.h); this.ctx.fillStyle = 'rgba(255,255,255,0.2)'; this.ctx.fillRect(b.x, b.y, b.w, b.h/2); });
        this.powerUps.forEach(p => {
            this.ctx.beginPath(); this.ctx.arc(p.x, p.y - 5, 20, 0, Math.PI*2); this.ctx.fillStyle = 'rgba(0,0,0,0.5)'; this.ctx.fill();
            let strokeColor = '#fff'; if (p.type === 'nuke') strokeColor = '#ef4444'; else if (p.type === 'multiball') strokeColor = '#22c55e'; else if (p.type === 'expand') strokeColor = '#00c3ff'; else if (p.type === 'spen') strokeColor = '#ffff00'; else if (p.type === 'ai') strokeColor = '#ff00ff';
            this.ctx.lineWidth = 2; this.ctx.strokeStyle = strokeColor; this.ctx.stroke();
            this.ctx.font = "24px Arial"; this.ctx.textAlign = "center"; this.ctx.fillStyle = "#fff";
            let icon = "?"; if(p.type === 'expand') icon = "ğŸ“±"; else if(p.type === 'spen') icon = "ğŸ–Šï¸"; else if(p.type === 'ai') icon = "â„ï¸"; else if(p.type === 'nuke') icon = "ğŸ"; else if(p.type === 'multiball') icon = "ğŸ”´";
            if (p.type === 'gingerbread') icon = "ğŸª";
            this.ctx.fillText(icon, p.x, p.y);
        });
        this.ctx.fillStyle = '#ffff00'; this.bullets.forEach(b => this.ctx.fillRect(b.x, b.y, b.w, b.h));
        this.particles.forEach(p => { this.ctx.globalAlpha = p.life; this.ctx.fillStyle = p.color; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 3, 0, Math.PI*2); this.ctx.fill(); this.ctx.globalAlpha = 1; });
    }
    loop() { if(!this.running) return; this.update(); this.draw(); requestAnimationFrame(() => this.loop()); }
}

const api = GoogleSheetAPI;
const game = new Game();
</script>
</body>
</html>
